// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // Add this for direct connections
}

// User Authentication & Profile
model User {
  id           Int @id @default(autoincrement())
  email           String   @unique
  fullName        String
  handle          String?  @unique
  bio             String?
  profilePicture  String?
  coverPicture    String?
  socialLinks     Json?    // Store social media links as JSON
  googleId        String?  @unique
  password        String?  // Nullable for Google OAuth users
  emailVerified   Boolean  @default(false)
  isActive        Boolean  @default(true)
  lastLogin       DateTime? // Nullable for new users
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relationships
  subscription    Subscription?
  creditHistory   CreditTransaction[]
  images          Image[]
  inputImages     InputImage[]      // Track user uploaded images
  generationBatches GenerationBatch[] // Track generation batches
  likes           Like[]
  shares          Share[]

  @@map("users")
}

// Subscription Management
model Subscription {
  id           Int @id @default(autoincrement())
  userId            Int              @unique
  planType          SubscriptionPlan
  status            SubscriptionStatus
  credits           Int              @default(0)
  stripeCustomerId  String?
  stripeSubscriptionId String?
  currentPeriodStart DateTime?
  currentPeriodEnd  DateTime?
  billingCycle      BillingCycle     @default(MONTHLY)
  paymentFailedAttempts Int          @default(0)
  lastPaymentFailureDate DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  // Relationships
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// Credit Transaction History
model CreditTransaction {
  id           Int @id @default(autoincrement())
  userId      Int
  amount      Int               // Positive for credit, negative for debit
  type        CreditTransactionType
  status      TransactionStatus @default(COMPLETED)
  description String?
  batchId     Int?           // Reference to batch if credit used for generation
  expiresAt   DateTime?
  createdAt   DateTime          @default(now())

  // Relationships
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  batch       GenerationBatch?  @relation(fields: [batchId], references: [id])

  @@map("credit_transactions")
}

// Input Image History - Track all user uploaded images
model InputImage {
  id           Int @id @default(autoincrement())
  userId          Int
  originalUrl     String        // S3 URL of the uploaded image
  processedUrl    String?       // URL from external preprocessing API
  thumbnailUrl    String?
  fileName        String?
  fileSize        Int?          // File size in bytes
  dimensions      Json?         // Store width/height as JSON {width: 1920, height: 1080}
  uploadSource    UploadSource  // Where the image was uploaded from
  isDeleted       Boolean       @default(false)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  maskStatus    String?      @default("none") // "none", "processing", "completed", "failed"
  maskData      Json?        // store the complete callback response
  maskRegions   MaskRegion[]

  // Relationships
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  usedInBatches   GenerationBatch[] @relation("BatchInputUsage")
  usedInTweaks    TweakOperation[] @relation("TweakInputUsage")

  @@map("input_images")
}

// New MaskRegion model
model MaskRegion {
  id           Int @id @default(autoincrement())
  inputImageId          Int
  maskUrl               String
  color                 String    // rgb(r, g, b)
  materialOptionId      Int?      // Changed from String to Int
  customizationOptionId Int?      // Changed from String to Int
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relationships
  inputImage            InputImage           @relation(fields: [inputImageId], references: [id], onDelete: Cascade)
  materialOption        MaterialOption?      @relation(fields: [materialOptionId], references: [id])
  customizationOption   CustomizationOption? @relation(fields: [customizationOptionId], references: [id])

  @@map("mask_regions")
}

enum BatchStatus {
  PROCESSING
  COMPLETED
  PARTIALLY_COMPLETED
  FAILED
}

enum UploadSource {
  CREATE_MODULE
  TWEAK_MODULE
  REFINE_MODULE
  GALLERY_UPLOAD
}

// Generation Batch - Groups variations together
model GenerationBatch {
  id           Int @id @default(autoincrement())
  userId          Int
  inputImageId    Int?       // Reference to the input image used
  moduleType      ModuleType    // CREATE, TWEAK, REFINE
  prompt          String?
  totalVariations Int           @default(1) // Number of variations requested (1-4)
  status          BatchStatus   @default(PROCESSING)
  creditsUsed     Int           @default(1) // Credits used for the entire batch
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relationships
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  inputImage      InputImage?   @relation("BatchInputUsage", fields: [inputImageId], references: [id])
  variations      Image[]
  createSettings  CreateSettings?
  tweakBatch      TweakBatch?
  refineSettings  RefineSettings?
  creditTransactions CreditTransaction[]

  @@map("generation_batches")
}

// Individual Image Variations
model Image {
  id           Int @id @default(autoincrement())
  batchId           Int        // Reference to the generation batch
  userId            Int
  processedImageUrl String        // URL of final processed image
  thumbnailUrl      String?
  title             String?
  description       String?
  variationNumber   Int           // 1, 2, 3, or 4
  isPublic          Boolean       @default(false)
  status            ImageStatus   @default(PROCESSING)
  isFavorite        Boolean       @default(false) // User can mark favorite variation
  metadata          Json?         // Store additional metadata as JSON
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relationships
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  batch             GenerationBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  likes             Like[]
  shares            Share[]

  @@unique([batchId, variationNumber])
  @@map("images")
}

// Create Module Settings
model CreateSettings {
  id           Int @id @default(autoincrement())
  batchId         Int          @unique
  mode            String?         // "photorealistic" or "art"
  variations      Int             @default(1) // 1-4 variations requested
  creativity      Float           @default(50) // 0-100
  expressivity    Float           @default(50) // 0-100
  resemblance     Float           @default(50) // 0-100
  buildingType    String?         // "walls", "floors", etc.
  category        String?         // "residential", "commercial"
  context         String?         // "exterior", "interior", "aerial", "elevation"
  style           String?         // "art-deco", "bauhaus", etc.
  regions         Json?           // Store region definitions as JSON
  createdAt       DateTime        @default(now())

  // Relationships
  batch           GenerationBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@map("create_settings")
}

// Tweak Module Batch Operations
model TweakBatch {
  id           Int @id @default(autoincrement())
  batchId         Int            @unique
  baseImageUrl    String            // URL of the image being tweaked
  variations      Int               @default(1) // 1-4 variations requested
  createdAt       DateTime          @default(now())

  // Relationships
  batch           GenerationBatch   @relation(fields: [batchId], references: [id], onDelete: Cascade)
  operations      TweakOperation[]

  @@map("tweak_batches")
}

// Individual Tweak Operations within a batch
model TweakOperation {
  id           Int @id @default(autoincrement())
  tweakBatchId    Int
  operationType   TweakOperationType
  operationData   Json                // Store operation-specific data
  inputImageId    Int?             // Reference to any additional input image used
  sequenceOrder   Int                 // Order of operations within the batch
  createdAt       DateTime            @default(now())

  // Relationships
  tweakBatch      TweakBatch          @relation(fields: [tweakBatchId], references: [id], onDelete: Cascade)
  inputImage      InputImage?         @relation("TweakInputUsage", fields: [inputImageId], references: [id])

  @@map("tweak_operations")
}

// Refine Module Settings
model RefineSettings {
  id           Int @id @default(autoincrement())
  batchId       Int          @unique
  width         Int             @default(1969)
  height        Int             @default(1969)
  aiStrength    Float           @default(12) // 0-100
  resemblance   Float           @default(12) // 0-100
  clarity       Float           @default(12) // 0-100
  sharpness     Float           @default(12) // 0-100
  matchColor    Boolean         @default(false)
  zoomLevel     Float           @default(1) // 1x, 2x, 3x
  variations    Int             @default(1) // 1-4 variations requested
  createdAt     DateTime        @default(now())

  // Relationships
  batch         GenerationBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@map("refine_settings")
}

// Social Features
model Like {
  id           Int @id @default(autoincrement())
  userId    Int
  imageId   Int
  createdAt DateTime @default(now())

  // Relationships
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  image     Image    @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@unique([userId, imageId])
  @@map("likes")
}

model Share {
  id           Int @id @default(autoincrement())
  userId      Int
  imageId     Int
  platform    SharePlatform
  sharedAt    DateTime    @default(now())

  // Relationships
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  image       Image       @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@map("shares")
}

// Main Customization Categories (Photorealistic, Art)
model CustomizationCategory {
  id           Int @id @default(autoincrement())
  name         String        @unique // "photorealistic", "art"
  slug         String        @unique // "photorealistic", "art"
  displayName  String        // "Photorealistic", "Art"
  description  String?
  imageUrl     String?
  isActive     Boolean       @default(true)
  orderIndex   Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  // Relationships
  subCategories CustomizationSubCategory[]

  @@map("customization_categories")
}

// Sub-categories under main categories (Type, Walls, Floors, Context, etc.)
model CustomizationSubCategory {
  id           Int @id @default(autoincrement())
  categoryId   Int
  name         String        // "type", "walls", "floors", "context", etc.
  slug         String        // "type", "walls", "floors", "context", etc.
  displayName  String        // "Type", "Walls", "Floors", "Context", etc.
  description  String?
  imageUrl     String?
  hasSubItems  Boolean       @default(false) // true for Walls/Floors, false for Type
  isActive     Boolean       @default(true)
  orderIndex   Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  // Relationships
  category     CustomizationCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  materialCategories MaterialCategorySubCategory[] // Junction table
  options      CustomizationOption[]   // For Type, Context, Style, Weather, Lighting

  @@unique([categoryId, slug])
  @@map("customization_sub_categories")
}

// Material Categories (Brick, Ceramics, Glass, etc.) - only for Walls/Floors
model MaterialCategory {
  id           Int @id @default(autoincrement())
  name         String        @unique // Make this unique globally
  slug         String        @unique // Make this unique globally
  displayName  String        // "Brick", "Ceramics", "Glass"
  description  String?
  imageUrl     String?
  tags         String[]      // Array of tags for filtering
  isActive     Boolean       @default(true)
  orderIndex   Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  // New many-to-many relationship
  subCategories MaterialCategorySubCategory[] // Junction table
  options      MaterialOption[]

  @@map("material_categories")
}

// Junction table for many-to-many relationship
model MaterialCategorySubCategory {
  id               Int @id @default(autoincrement())
  materialCategoryId Int
  subCategoryId    Int
  orderIndex       Int @default(0) // Order within each subcategory
  createdAt        DateTime @default(now())

  // Relationships
  materialCategory MaterialCategory @relation(fields: [materialCategoryId], references: [id], onDelete: Cascade)
  subCategory      CustomizationSubCategory @relation(fields: [subCategoryId], references: [id], onDelete: Cascade)

  @@unique([materialCategoryId, subCategoryId])
  @@map("material_category_sub_categories")
}

// Material Options (Individual brick types, ceramic types, etc.)
model MaterialOption {
  id           Int @id @default(autoincrement())
  categoryId   Int
  name         String        // "White Brick Clean white appearance"
  slug         String        // "white-brick-clean"
  displayName  String        // "White Brick"
  description  String?       // "Clean white appearance"
  imageUrl     String?
  thumbnailUrl String?
  tags         String[]      // Array of tags for filtering
  isActive     Boolean       @default(true)
  orderIndex   Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  // Relationships
  category     MaterialCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  maskRegions  MaskRegion[]     // Add this reverse relation

  @@unique([categoryId, slug])
  @@map("material_options")
}

// Customization Options (for Type, Context, Style, Weather, Lighting)
model CustomizationOption {
  id           Int @id @default(autoincrement())
  subCategoryId Int
  name         String        // "RESIDENTIAL BUILDINGS", "URBAN STREETS"
  slug         String        // "residential-buildings", "urban-streets"
  displayName  String        // "Residential Buildings", "Urban Streets"
  description  String?
  imageUrl     String?
  thumbnailUrl String?
  tags         String[]      // Array of tags for filtering
  isActive     Boolean       @default(true)
  orderIndex   Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  // Relationships
  subCategory  CustomizationSubCategory @relation(fields: [subCategoryId], references: [id], onDelete: Cascade)
  maskRegions  MaskRegion[]             // Add this reverse relation

  @@unique([subCategoryId, slug])
  @@map("customization_options")
}

// Enums
enum SubscriptionPlan {
  FREE
  BASIC
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  INACTIVE
  ACTIVE
  PAST_DUE
  UNPAID
  CANCELLED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum CreditTransactionType {
  SUBSCRIPTION_CREDIT
  IMAGE_CREATE
  IMAGE_TWEAK
  IMAGE_REFINE
  PURCHASE
  REFUND
  EXPIRATION
}

enum ModuleType {
  CREATE
  TWEAK
  REFINE
}

enum ImageStatus {
  PROCESSING
  COMPLETED
  FAILED
}

enum TweakOperationType {
  SELECT_RESIZE
  CHANGE_REGION
  CUT_OBJECTS
  ADD_IMAGE
}

enum SharePlatform {
  LINKEDIN
  TWITTER
  FACEBOOK
  DIRECT_LINK
}

enum TransactionStatus {
  PENDING
  COMPLETED
  REFUNDED
  FAILED
}